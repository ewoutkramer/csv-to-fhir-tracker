<!doctype html>
<html>
  <head>
    <style>
      #submissions {width: 100%; border: 1em solid black; box-sizing: border-box;}
      iframe {width: 100%; border: 1em solid yellow; box-sizing: border-box; zoom: 50%}
      button {margin-bottom: 2em;}
      #holder {visibility: hidden;}
    </style>
  </head>
  <body>

    CSV File: 
    <input type="file" id="csv" name="csvfile"/> <br>
    Min comment #: <input type="text" id="min-comment" value="1" size="3"/><br>
    Max comment #: <input type="text" id="max-comment" value="1" size="3"/><br>
    <button DISABLED id="create">Create issues</button>
    <div id="holder"></div>
    <iframe id="submitter"></iframe>

    <script src="jquery-2.1.3.min.js"></script>
    <script src="papaparse.js"></script>
    <script>
      var gforge = "http://gforge.hl7.org";
      //var gforge = "http://localhost:9999";
      var tracker = "/gf/project/fhir/tracker/?action=TrackerItemAdd&tracker_id="; 
      var tid = "914";
      var MAX_ISSUES = 999;

      var page = null;
      var form = null;
      var issues = null;

      var loaded = 0;
      var processed = 0;

      function processOneIssue(){
        //console.log("Processing issue");
        $("#submitter").attr("src", "");

        iframeBody = $("#submitter").contents().find("body");
        iframeBody.empty();
        var formCopy = form.cloneNode(true);

        var issue = issues[processed++];
        if (!issue || processed > MAX_ISSUES) {
          $("#submitter").removeAttr("onLoad");
          $("button").removeAttr("disabled");
          return;
        }

        fillOut(formCopy, issue);
        iframeBody.append(formCopy);
        //console.log("filled as", formCopy);
        window.formCopy = formCopy;
        $("#submitter").attr("onLoad", "processOneIssue()");
        formCopy.submit();
      }


      var bodyFields = [
      "Comment Number",
      "Section Number", 
      "Page or Section URL", 
      "Vote and Type",
      "Existing Wording",
      "Proposed Wording",
      "Comments",
      "In person resolution requested",
      "Comment grouping",
      "Disposition WG",
      "Tracker Category",
      "Resource(s)",
      "page(s)", 
      "Priority",
      "Disposition",
      "Disposition Comment",
      "Disposition Date", 
      "Mover / seconder",
      "For",
      "Against",
      "Abstain",
      "Retracted / Withdrawn",
      "Responsible Person",
      "Change Applied",
      "Substantive Change",
      "Submitted By",
      "Organization",
      "On behalf of",
      "On Behalf of Email",
      "Submitter Tracking ID"
      ];

      var structuredFields = [
      "Section Number",  
      "Page or Section URL", 
      "Disposition WG",
      "Tracker Category",
      "Resource(s)",
      "page(s)", 
      // "Priority", // I don't see what this maps to
      // "Disposition", // I don't see what this maps to
      ];

      fieldMaps = {
        "Section Number":  [FormElementCalled("Section Number"), ValFiller],
        "Page or Section URL":  [FormElementCalled("url"), ValFiller],
        "Resource(s)": [FormElementCalled("Resource(s)"), SelectFiller],
        "page(s)": [FormElementCalled("HTML Page"), SelectFiller],
        "Disposition WG": [FormElementCalled("Reviewing Work Group(s)"), SelectFiller],
        "Tracker Category": [FormElementCalled("Category"), SelectFiller]
      };


      function fillOut(form, issue){
        importantFields = bodyFields.reduce(function(dict, v){
          dict[v] = issue[v];
          return dict;
        }, {});

        content = JSON.stringify(importantFields, null, 2)
        .replace(new RegExp("\n", "g"), "<br>\n");
        details = $("textarea[name='details']", form);
        details.val(content);

        $("input[name='summary']", form).val("Ballot comment #"+issue["Comment Number"])

        if (issue["Tracker Category"] == ""){
          issue["Tracker Category"] = "None";
        }

        structuredFields.forEach(function(f){
          var val = issue[f];
          if (!fieldMaps[f]) return;
          var getter = fieldMaps[f][0];
          var filler = fieldMaps[f][1];
          var field = getter(form);
          filler(field, val);
          //console.log("Tried filling", field, val, field.val());
        });
      }


      function loadOne(){
        if (++loaded >= 2)
        $("button").removeAttr("disabled");
      }

      var source = gforge+tracker+tid;
      var source = "fake-gforge-source.html";
      $.ajax(source).done(function(newp){
        page = newp;
        form = $("form", page)[0].cloneNode(true);
        $("input[name='monitor']", form)[0].removeAttribute("checked");
        form.setAttribute("action", gforge + form.getAttribute("action"));
        $("div", form).remove();
        $("script", form).remove();
        console.log("got the blank form");
        loadOne();
      });

      $("#csv").change(function(){
        console.log("Parsing");
        Papa.parse($("#csv")[0].files[0], {
          header: true,
          complete: function(results) {
            console.log("Parsed");
            window.results = results;
            loadOne();
          }
        });
      });


      function FormElementCalled(text){
        return function(form){
          el = $("strong", form).filter(function(i,e){
            return $(e).text() == text;
          })[0];
          return $(el).next().next();
        }
      }

      function TextValueFiller(elementGetter, value) {
        elt = elementGetter();
        elt.value
      }

      function ValFiller(field, value){
        field.val(value);
      }

      function SelectFiller(field, value){
        $("option", field).each(function(i, o){
          var isMatch = o.text.match(new RegExp(value, "i"));
          //console.log("Matching for ", value, o.text, isMatch);
          if (isMatch){
            o.setAttribute("selected", "selected");
            } else {
            o.removeAttribute("selected");
          }
        });
      }
      $("#create").click(function(){
        $("button").attr("disabled", "true");
        var min = parseInt($("#min-comment").val());
        var max = parseInt($("#max-comment").val());
        console.log("Restrinctnig from", min, max, results.data.length);
        window.issues = results.data.filter(function(i){
          var cnum = parseInt(i["Comment Number"]);
          return cnum >= min && cnum <= max; 
        });
        processOneIssue();
      });

    </script>
  </body>
</html>
